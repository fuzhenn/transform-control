/*!
 * @maptalks/gltf-layer v0.12.3
 * LICENSE : UNLICENSED
 * (c) 2016-2020 maptalks.org
 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("@maptalks/gl"),require("maptalks")):"function"==typeof define&&define.amd?define(["exports","@maptalks/gl","maptalks"],i):i((t=t||self).maptalks=t.maptalks||{},t.maptalksgl,t.maptalks)}(this,function(t,p,g){"use strict";function u(t,i){t.prototype=Object.create(i.prototype),(t.prototype.constructor=t).__proto__=i}function s(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function h(t){return null==t}function a(t){return!h(t)}function f(t,i){var n=new Set(i);return Array.from(new Set(t.filter(function(t){return n.has(t)})))}for(var _=[],i=0;i<6;i++)_[i]=[];var P=[];function c(t,i,n){var r,e,o,s,u,h,a,f,c,v,l,m,d,p,g,y,x;e=(r=t)[0],o=r[1],s=r[2],u=r[3],h=r[4],a=r[5],f=r[6],c=r[7],v=r[8],l=r[9],m=r[10],d=r[11],p=r[12],g=r[13],y=r[14],x=r[15],S(_[0],u-e,c-h,d-v,x-p),S(_[1],u+e,c+h,d+v,x+p),S(_[2],u+o,c+a,d+l,x+g),S(_[3],u-o,c-a,d-l,x-g),S(_[4],u-s,c-f,d-m,x-y),S(_[5],u+s,c+f,d+m,x+y);for(var w,b,M=0;M<6;M++)if(!n||"0"!==n.charAt(M)){var O=_[M];if(P[0]=0<O[0]?i[1][0]:i[0][0],P[1]=0<O[1]?i[1][1]:i[0][1],P[2]=0<O[2]?i[1][2]:i[0][2],b=P,(w=O)[0]*b[0]+w[1]*b[1]+w[2]*b[2]+w[3]<0)return}return 1}var o=1/6;function S(t,i,n,r,e){return t[0]=i*o,t[1]=n*o,t[2]=r*o,t[3]=e*o,t}var n,r,e,v,l,m,d,y={},x=0,w={lightAmbient:[1,1,1],lightDiffuse:[1,1,1],lightSpecular:[1,1,1],lightDirection:[1,1,1]},b=[1,1,1,1],M=[.2107,-.0202],O=(v=.5*Math.PI,l=Math.cos(v),m=Math.sin(v),(d=[])[0]=1,d[1]=0,d[2]=0,d[3]=0,d[4]=l,d[5]=m,d[6]=0,d[7]=-m,d[8]=l,r=[0,0,0],(e=[])[0]=(n=d)[0],e[1]=n[1],e[2]=n[2],e[3]=0,e[4]=n[3],e[5]=n[4],e[6]=n[5],e[7]=0,e[8]=n[6],e[9]=n[7],e[10]=n[8],e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e),k=function(n){function t(t){var i=n.call(this,t)||this;return i.gltfScenes={},i.t={},i.i={},i.n=[],i.r(),i}u(t,n);var i=t.prototype;return i.draw=function(t,i){x=t,this.prepareCanvas(),this.e(i)},i.drawOnInteracting=function(t,i,n){x=i,this.e(n)},i.needToRedraw=function(){var t=this.layer.o();for(var i in t){if(t[i].isDirty())return!0}return n.prototype.needToRedraw.call(this)},i.hitDetect=function(){return!1},i.createContext=function(){var t,i=this,n=this.canvas.gl&&this.canvas.gl.wrap;n?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):(t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0},this.glOptions=t,this.gl=this.gl||this.s(this.canvas,t),this.regl=p.createREGL({gl:this.gl,extensions:["ANGLE_instanced_arrays","OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","EXT_shader_texture_lod","OES_element_index_uint","OES_standard_derivatives","WEBGL_depth_texture"],optionalExtensions:this.layer.options.glExtensions||[]})),n&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.u(),this.h&&this.h.forEach(function(t){t.generateInstancedBuffers(i.regl)}),this.a&&this.a.forEach(function(t){t.generateBuffers(i.regl)})},i.u=function(){var t=this.layer.getMap(),i=new p.reshader.Renderer(this.regl);this.renderer=i,this.f={projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,viewMatrix:t.viewMatrix,uCameraPosition:t.cameraPosition,cameraPosition:t.cameraPosition,altitudeScale:1},t.getLightConfig()&&(this.c(),t.on("updatelights",this.l,this)),this.m=new p.reshader.FBORayPicking(i,{vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\n//引入fbo picking的vert相关函数\n\n#include <fbo_picking_vert>\n\n#include <get_output>\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projViewMatrix * modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n    //传入gl_Position的depth值\n\n    fbo_picking_setData(gl_Position.w, true);\n\n}\n\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,i){return p.mat4.multiply([],i.projViewMatrix,i.modelMatrix)}},"projViewMatrix","uPickingId","positionMatrix"]},this.pickingFBO)},i.r=function(){var t=y;for(var i in t){var n=t[i];this.d(n.name,n.type,n.config)}},i.p=function(n){var t,r=this,i=n.getShader(),e=this.t[n.getUrl()],o=this.gltfScenes[n.g()];e&&o&&(t=o.modelMeshes,"wireframe"===i?(e.geometries.forEach(function(t){t.copyGeometry.data.aBarycentric||(t.copyGeometry.buildUniqueVertex(),t.copyGeometry.createBarycentric("aBarycentric"),r.regl?t.copyGeometry.generateBuffers(r.regl):(r.a=r.a||[],r.a.push(t.copyGeometry)))}),t.forEach(function(t){var i=r.w(n,t.b);t.geometry=t.b.copyGeometry,t.material=i})):t.forEach(function(t){var i=r.w(n,t.b);t.geometry=t.b.geometry,t.material=i}))},i.d=function(t,i,n){var r=this;this.viewport={x:0,y:0,width:function(){return r.canvas?r.canvas.width:1},height:function(){return r.canvas?r.canvas.height:1}},n.extraCommandProps||(n.extraCommandProps={});var e=g.Util.extend({},n);e.uniforms=g.Util.extend([],n.uniforms),e.extraCommandProps=g.Util.extend({},n.extraCommandProps),e.extraCommandProps.viewport=this.viewport,-1<i.indexOf(".")?(i=i.split("."),this.i[t]={shader:new p.reshader[i[0]][i[1]](e)}):this.i[t]={shader:new p.reshader[i](e),type:i},this.shaderListTest=this.i},i.remove=function(){this.M(),n.prototype.remove.call(this)},i.clearCanvas=function(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),n.prototype.clearCanvas.call(this))},i.resizeCanvas=function(t){n.prototype.resizeCanvas.call(this,t),this.pickingFBO&&this.pickingFBO.resize(this.canvas.width,this.canvas.height),this.layer.fire("resizecanvas",{size:t})},i.e=function(h){var a=this,f=0;if(!function(t){var i;for(i in t)return;return 1}(this.gltfScenes)){this.n.splice(0,this.n.length);for(var t in this.i){var i=function(i){var t=a.layer.getGeometries().filter(function(t){return t.isVisible()&&t.getShader()===i});if(!t.length)return"continue";a.O(t);var n=a._(t,i);if(!n)return"continue";var r=a.i[i].shader,e=n.getMeshes();n.sortMeshes(a.f.uCameraPosition),a.f.uGlobalTexSize=a.f.globalTexSize=[a.canvas.width,a.canvas.height];var o,s=null,u={};if(h?(h.states.includesChanged&&(o={vert:r.vert,frag:r.frag,uniforms:r.uniforms,extraCommandProps:r.extraCommandProps},r.dispose(),a.i[i].shader=r=a.P(h,o,a.i[i].type)),a.f.uHalton=a.f.halton=h.jitter||[0,0],r.filter=h.sceneFilter,s=h.renderTarget&&h.renderTarget.fbo,u=a.S(h,r,u)):a.f.uHalton=a.f.halton=M,a.k(h),"pbr"===i&&!a.A)return{v:void 0};g.Util.extend(u,a.f),a.renderer.render(r,u,n,s),a.T(e),f++}(t);switch(i){case"continue":continue;default:if("object"==typeof i)return i.v}}this.C=!0,this.layer.fire("rendercomplete-debug",{count:f}),this.completeRender()}},i.P=function(t,i,n){var r=g.Util.extend({},i.shaderDefines);for(var e in t.includes)t[e].defines&&g.Util.extend(r,r,t[e].defines);return i.defines=r,new p.reshader[n](i)},i.S=function(t,i,n){if(t.viewshed){for(var r in t.viewshed.renderUniforms)n[r]=t.viewshed.renderUniforms[r];g.Util.extend(i.shaderDefines,t.viewshed.defines)}if(t.floodAnalysis){for(var e in t.floodAnalysis.renderUniforms)n[e]=t.floodAnalysis.renderUniforms[e];g.Util.extend(i.shaderDefines,t.floodAnalysis.defines)}return n},i.getShadowMeshes=function(){var t=[];if(!this.layer)return t;for(var i,n=this.layer.getGeometries(),r=0;r<n.length;r++){n[r].isCastShadow()&&(i=n[r].g(),this.gltfScenes[i]&&(t=t.concat(this.gltfScenes[i].modelMeshes)))}return t},i.getAnalysisMeshes=function(){return this.n},i.drawOutline=function(t){this.extentShader||(this.extentShader=new p.reshader.MeshShader({vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\n#include <get_output>\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projViewMatrix * modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n}\n\n",frag:"precision highp float;\n\nvoid main() {\n\n    gl_FragColor = vec4(1.0);\n\n}\n\n",positionAttribute:"POSITION",extraCommandProps:{viewport:this.viewport,cull:{enable:!1}}}));var i,n=this.getOutlineMeshes();n.length&&(i=new p.reshader.Scene(n),this.renderer.render(this.extentShader,{projViewMatrix:this.f.projViewMatrix},i,t))},i.getOutlineMeshes=function(){var t=[];if(!this.layer)return t;for(var i,n=this.layer.getGeometries(),r=0;r<n.length;r++){n[r].isOutline()&&n[r].I()&&(i=n[r].g(),this.gltfScenes[i]&&(t=t.concat(this.gltfScenes[i].modelMeshes)))}return t},i.T=function(t){for(var i=0;i<t.length;i++)this.n.push(t[i])},i.O=function(t){var n=this;t.forEach(function(t){var i=t.g();n.gltfScenes[i]&&(n.N(i),t.isAnimated()||t.hasFunctionDefinition()||t.isOutline()?t.setDirty(!0):t.setDirty(!1))})},i.j=function(t,i){return!("wireframe"===i&&!t.geometry.data.aBarycentric)},i._=function(t,i){for(var n=[],r=this.layer.getMap(),e=0;e<t.length;e++){var o=t[e],s=this.gltfScenes[o.g()];if(s)for(var u=s.modelMeshes,h=0;h<u.length;h++){var a=u[h];this.j(a,i)&&(this.L(a,o),this.F(a,o),a.setUniform("uPickingId",o.g()),(a instanceof p.reshader.InstancedMesh||c(r.projViewMatrix,a.getBoundingBox()))&&n.push(a))}}return n.length?new p.reshader.Scene(n):null},i.G=function(t,i,n){var r=t.geometry;t.copyGeometry||(t.copyGeometry=this.J(r)),"wireframe"===n&&p.reshader.Util.isArray(t.copyGeometry.elements)&&(t.copyGeometry.buildUniqueVertex(),t.copyGeometry.createBarycentric("aBarycentric"));var e=this.R(i,t,n),o=e.getDefines();return e instanceof p.reshader.InstancedMesh?(o.HAS_PICKING_ID=1,o.HAS_INSTANCE_COLOR=1):o.HAS_PICKING_ID=2,e.setDefines(o),e},i.R=function(t,i,n){var r,e,o=this.layer.o()[t],s=o.getGLTFMarkerType(),u=null,h=this.w(o,i),a="wireframe"===n?i.copyGeometry:i.geometry;return this.regl?a.generateBuffers(this.regl):(this.a=this.a||[],this.a.push(a)),"groupgltfmarker"===s?(o.V(),r=o.z(p.mat4.identity([])),e=o.getCount(),u=new p.reshader.InstancedMesh(r,e,a,h),this.regl?u.generateInstancedBuffers(this.regl):(this.h=this.h||[],this.h.push(u))):u=new p.reshader.Mesh(a,h),u.nodeMatrix=i.nodeMatrix,u.b=i,o.isBloom()&&u.setUniform("bloom",!0),this.F(u,o),u},i.J=function(t){var i=t.data,n=t.elements.length,r={},e=t.getVertexCount();for(var o in i){var s=i[o].length/e;r[o]=new i[o].constructor(n*s);for(var u=0;u<n*s;u++)r[o][u]=i[o][u]}var h=t.elements.slice(),a=t.count,f=JSON.parse(JSON.stringify(t.desc));return new p.reshader.Geometry(r,h,a,f)},i.w=function(t,i){var n=null,r=t.getShader(),e=t.getUniforms()||{},o=i.materialInfo||{};if("phong"===r)if("pbrSpecularGlossiness"===o.name)n=new p.reshader.PhongSpecularGlossinessMaterial(o);else{for(var s in w)e[s]=e[s]||w[s];n=new p.reshader.PhongMaterial(o)}else n="wireframe"===r?new p.reshader.WireFrameMaterial(o):"pbr"===r?"pbrSpecularGlossiness"===o.name?new p.reshader.pbr.PBRSpecularGlossinessMaterial(o):new p.reshader.pbr.StandardMaterial(o):new p.reshader.Material(o);for(var u in e)n.set(u,e[u]);return i.skin?(n.set("jointTextureSize",[4,6]),n.set("numJoints",i.skin.numJoints),n.set("jointTexture",i.skin.jointTexture),n.set("skinAnimation",1)):n.set("skinAnimation",0),n},i.F=function(t,i){var n=i.getSymbol();n?(t.setUniform("polygonFill",n.polygonFill||b),t.setUniform("polygonOpacity",void 0===n.polygonOpacity?1:n.polygonOpacity),t.setUniform("lineColor",n.lineColor||b),t.setUniform("lineOpacity",void 0===n.lineOpacity?1:n.lineOpacity)):(t.setUniform("polygonFill",b),t.setUniform("polygonOpacity",1),t.setUniform("lineColor",b),t.setUniform("lineOpacity",1))},i.c=function(){var t,i,n,r=this.layer.getMap();r&&(i=(t=p.reshader.pbr.PBRUtils).createIBLTextures,n=t.disposeIBLTextures,this.D=p.reshader.pbr.PBRHelper.generateDFGLUT(this.regl),this.A&&n(this.A),this.A=i(this.regl,r))},i.M=function(){var t=p.reshader.pbr.PBRUtils.disposeIBLTextures;this.A&&t(this.A);var i=this.layer.getMap();i&&i.off("updatelights",this.l),delete this.A},i.l=function(t){t.ambientUpdate&&this.c()},i.k=function(t){var i,n,r,e=this.layer.getMap();e&&e.getLightConfig()&&(i=p.reshader.pbr.PBRUtils.getPBRUniforms(e,this.A,this.D,this.gl,t),r=(n=e.getLightConfig()).ambient&&n.ambient.color?n.ambient.color:[.2,.2,.2],this.f.uAmbientColor=r,i&&g.Util.extend(this.f,i))},i.L=function(t,i){"effectmarker"===i.getGLTFMarkerType()?i.updateUV(x):"glowmarker"===i.getGLTFMarkerType()&&i.H();var n=i.getUniforms();if(n)for(var r in n)t.material.set(r,n[r]);t.setUniform("bloom",i.isBloom())},i.q=function(t,i){var n,r=this,e=t.g(),o=[],s=t.getShader(),u=this.t[i];u?(u.geometries.forEach(function(t){var i=r.G(t,e,s);o.push(i)}),u.count+=1):(n=t.B(),this.t[i]={pickingId:e,json:n,geometries:[],count:1},o=this.X(n,e,i,s)),t.gltfPack=this.t[i].gltfPack,this.gltfScenes[e]={pickingId:e,modelMeshes:o};var h=t.getUrl();t.U()?t.U()&&t.$()!==h&&(t.Y([1,1,1]),t.W([0,0,0]),this.Z(t,o)):this.Z(t,o),t.setDirty(!0)},i.Z=function(t,i){this.N(t.g());var n=this.K(i,t),r=this.Q(n);t.Y(r),t.W(this.tt(n,t))},i.X=function(t,n,r,e){var o=this,s=[],i=p.reshader.GLTFHelper.exportGLTFPack(t,this.regl),u=i.getMeshesInfo();return this.t[r].gltfPack=i,u.forEach(function(t){var i=o.G(t,n,e);o.t[r].geometries.push(t),s.push(i)}),s},i.Q=function(t){var i,n,r,e,o,s,u,h=[t.max[0]-t.min[0],t.max[1]-t.min[1],t.max[2]-t.min[2]],a=Math.max.apply(Math,h),f=(i=this.layer.getMap(),n=this.layer.it(),r=i.getCenter(),e=i.locateByPoint(r,n,0),o=i.getGLZoom(),s=i.coordToPoint(r,o),u=i.coordToPoint(e,o),Math.abs(u.x-s.x))/a;return p.vec3.set([],f,f,f)},i.tt=function(t,i){if("groupgltfmarker"===i.getGLTFMarkerType())return[0,0,-t.min[2]];var n=i.nt();return[-(t.min[0]+t.max[0])/2+n[0],-(t.min[1]+t.max[1])/2+n[1],-t.min[2]]},i.K=function(t){if(!t||!t.length)return null;for(var i=t[0].getBoundingBox(),n=i[0],r=i[1],e=1;e<t.length;e++){var o=t[e].getBoundingBox(),s=o[0],u=o[1];s[0]<n[0]&&(n[0]=s[0]),s[1]<n[1]&&(n[1]=s[1]),s[2]<n[2]&&(n[2]=s[2]),u[0]>r[0]&&(r[0]=u[0]),u[1]>r[1]&&(r[1]=u[1]),u[2]>r[2]&&(r[2]=u[2])}return{min:n,max:r}},i.rt=function(t,i){for(var n in i)t.setUniform(n,i[n]);return t},i.N=function(t){var i,s,n,u,r,h,a,f,c,v,l,m,d=this,e=this.gltfScenes[t];e&&(i=this.layer.o(),s=i[t],n=i[t].getUrl(),this.t[n]&&this.t[n].json&&(s.et(),(u=s.isAnimated())&&s.gltfPack&&this.ot(s)&&s.gltfPack.updateAnimation(x,s.isLooped(),s.getAnimationSpeed()),r=e.modelMeshes,h=s.getModelMatrix(),p.mat4.multiply(h,h,O),a=this.layer.getMap(),f=s.st(),c=s.U()||[0,0,0],v=[],l=[],m=[],r.forEach(function(t){var i,n,r=[1,1,1],e=s.getSymbol(),o=e&&e.fixSizeOnZoom;g.Util.isNumber(o)&&o<a.getZoom()&&(i=a.getGLScale()/a.getGLScale(o),p.vec3.set(r,i,i,i)),p.vec3.multiply(l,f,r),t instanceof p.reshader.InstancedMesh?(p.mat4.multiply(t.positionMatrix,h,t.nodeMatrix),p.vec3.scale(m,l,t.instanceCount),p.mat4.scale(t.positionMatrix,t.positionMatrix,m),p.vec3.scale(m,l,1/t.instanceCount),n=p.vec3.multiply(v,c,m),t.positionMatrix[12]+=n[0],t.positionMatrix[13]+=n[1],t.positionMatrix[14]+=n[2],d.ut(t,s)):(p.mat4.multiply(t.localTransform,h,t.nodeMatrix),p.mat4.scale(t.localTransform,t.localTransform,l),p.vec3.multiply(v,c,l),t.localTransform[12]+=v[0],t.localTransform[13]+=v[1],t.localTransform[14]+=v[2]),u?t.material.set("skinAnimation",1):t.material.set("skinAnimation",0)})))},i.ut=function(t,i){var n=i.z();for(var r in n)t.updateInstancedData(r,n[r]);t.updateBoundingBox(),this.regl?t.generateInstancedBuffers(this.regl):(this.h=this.h||[],this.h.push(t)),t.instanceCount=i.getCount()},i.ht=function(t){a(t)&&(this.at(t),delete this.gltfScenes[t],this.setToRedraw())},i.ft=function(){for(var t in this.gltfScenes){this.at(t);var i=this.layer.o()[t].getUrl();this.t[i]&&(this.t[i].count=0);var n=this.layer.o()[t].gltfPack;n&&n.dispose()}this.gltfScenes={},this.setToRedraw()},i.at=function(t){var i,n=this;this.gltfScenes[t]&&(i=this.layer.o()[t].getUrl(),this.t[i]&&--this.t[i].count,this.gltfScenes[t].modelMeshes.forEach(function(t){n.t[i]&&n.t[i].count<=0&&t.geometry.dispose(),t.material&&t.material.dispose(),t.dispose()}),this.t[i]&&this.t[i].count<=0&&delete this.t[i])},i.s=function(t,i){for(var n=["webgl","experimental-webgl"],r=null,e=0;e<n.length;++e){try{r=t.getContext(n[e],i)}catch(t){}if(r)break}return r},i.ct=function(t,i,n){if(void 0===n&&(n={}),!this.m)return null;var r=this.layer.getMap();if(this.C){if(!this.n||0===this.n.length)return null;var e=this.n;this.m.render(e,this.f,!0),this.C=!1}var o=this.m.pick(t,i,n.tolerance||3,{projViewMatrix:r.projViewMatrix},{viewMatrix:r.viewMatrix,projMatrix:r.projMatrix,returnPoint:!0}),s=o.meshId,u=o.pickingId,h=o.point,a=this.vt(u);return{meshId:s,target:this.layer.o()[a],pickingId:u,point:h}},i.vt=function(t){if(!a(t))return null;if(this.layer.o()[t])return t;for(var i=Object.keys(this.layer.o()).sort().map(function(t){return Number(t)}),n=i.length,r=0,e=n-1,o=Math.floor((r+e)/2);r<=n-1&&0<=e;){if(r===e)return i[r];if(i[o]<=t&&t<i[o+1])return i[o];t<i[o]?(e=o-1,o=Math.floor((r+e)/2)):i[o+1]<t&&(r=o+1,o=Math.floor((r+e)/2))}return null},i.ot=function(t){return"effectmarker"!==t.getGLTFMarkerType()&&"glowmarker"!==t.getGLTFMarkerType()},i.getRenderMeshesTest=function(){return this.n},t}(g.renderer.OverlayLayerCanvasRenderer);function A(r,t){var i,n,e;if(F(r)){var o,s=r.stops&&"object"==typeof r.stops[0][0],u=s||void 0!==r.property,h=s||!u,a=r.type||t||"exponential";if("exponential"===a)o=I;else if("interval"===a)o=C;else if("categorical"===a)o=T;else{if("identity"!==a)throw new Error('Unknown function type "'+a+'"');o=N}if(s){for(var f={},c=[],v=0;v<r.stops.length;v++){var l=r.stops[v];void 0===f[l[0].zoom]&&(f[l[0].zoom]={zoom:l[0].zoom,type:r.type,property:r.property,default:r.default,stops:[]}),f[l[0].zoom].stops.push([l[0].value,l[1]])}for(var m in f)c.push([f[m].zoom,A(f[m])]);e=n=!(i=function(t,i){var n=I({stops:c,base:r.base},t)(t,i);return"function"==typeof n?n(t,i):n})}else e=h?(i=function(t){var i=o(r,t);return"function"==typeof i?i(t):i},!(n=!0)):!(n=!(i=function(t,i){var n=o(r,i?i[r.property]:null);return"function"==typeof n?n(t,i):n}))}else i=function(){return r},e=n=!0;return i.isZoomConstant=e,i.isFeatureConstant=n,i}function T(t,i){for(var n=0;n<t.stops.length;n++)if(i===t.stops[n][0])return t.stops[n][1];return t.default}function C(t,i){for(var n=0;n<t.stops.length&&!(i<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function I(t,i){for(var n=void 0!==t.base?t.base:1,r=0;!(r>=t.stops.length||i<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:function n(r,e,o,s,u,h){return"function"==typeof u?function(){var t=u.apply(void 0,arguments),i=h.apply(void 0,arguments);return n(r,e,o,s,t,i)}:(u.length?L:j)(r,e,o,s,u,h)}(i,n,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}function N(t,i){return n=i,r=t.default,void 0!==n?n:void 0!==r?r:void 0!==e?e:null;var n,r,e}function j(t,i,n,r,e,o){var s=r-n,u=t-n,h=1===i?u/s:(Math.pow(i,u)-1)/(Math.pow(i,s)-1);return e*(1-h)+o*h}function L(t,i,n,r,e,o){for(var s=[],u=0;u<e.length;u++)s[u]=j(t,i,n,r,e[u],o[u]);return s}function F(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function E(t){for(var i in t)if(F(t[i]))return!0;return!1}function G(t){return function(t,i){if(!F(t))return function(){return t};t=JSON.parse(JSON.stringify(t));for(var n=!0,r=!0,e=t.stops,o=0;o<e.length;o++){var s;F(e[o][1])&&(s=A(e[o][1],i),n=n&&s.isZoomConstant,r=r&&s.isFeatureConstant,e[o]=[e[o][0],s])}var u=A(t,i);return u.isZoomConstant=n&&u.isZoomConstant,u.isFeatureConstant=r&&u.isFeatureConstant,u}(t,"exponential")}var J=[],R=function(o){function i(t,i){var n=g.Util.extend({},i),r=n.symbol,e=o.call(this,t,n)||this;return e.options.symbol=r,e.lt=!1,e.mt=p.mat4.identity([]),e.dt="gltfmarker",e.pt=!0,e.gt={get translation(){return[0,0,0]},get rotation(){return[0,0,0]},get scale(){return[1,1,1]}},e.et(),e}u(i,o),i.fromJSON=function(t){return new i(t.coordinates,t.options)};var t=i.prototype;return t.B=function(){return this.yt},t.xt=function(t){this.yt=t},t.wt=function(t,i){"url"===t&&(this.bt=this.getUrl()),this._externSymbol=this._externSymbol||{},this._externSymbol[t]=i},t.setUrl=function(t){return this.updateSymbol({url:t}),this.Mt&&this.Mt.Ot(this),this.pt=!0,this},t.updateSymbol=function(t){t.url&&(this.bt=this.getUrl()),o.prototype.updateSymbol.call(this,t)},t.$=function(){return this.bt},t.getUrl=function(){var t=this._getInternalSymbol();return t&&t.url||"cube"},t.addTo=function(t){if(this.Mt)throw new Error("GLTFMarker cannot be added to two or more layers at the same time.");return t.addGeometry(this),this._t(),this},t.remove=function(){this.Mt&&(this.Mt.Pt(this),o.prototype.remove.call(this))},t.show=function(){return o.prototype.updateSymbol.call(this,{visible:!0}),this.pt=!0,this},t.hide=function(){o.prototype.updateSymbol.call(this,{visible:!1}),this.pt=!0},t.setBloom=function(t){return o.prototype.updateSymbol.call(this,{bloom:t}),this.pt=!0,this},t.isBloom=function(){var t=this._getInternalSymbol();return t&&t.bloom},t.setCastShadow=function(t){return o.prototype.updateSymbol.call(this,{shadow:t}),this.pt=!0,this},t.isCastShadow=function(){var t=this._getInternalSymbol();return t&&t.shadow},t.setOutline=function(t){return this.options.outline=t,this._t(),this.setDirty(t),this},t.isOutline=function(){return this.options.outline},t._t=function(){this.options.outline?this.on("mousemove mouseenter mouseleave mouseout"):this.off("mousemove mouseenter mouseleave mouseout")},t.St=function(t){this.kt=t},t.I=function(){return this.kt},t.isVisible=function(){var t=this._getInternalSymbol();return!t||!a(t.visible)||t.visible},t.setCoordinates=function(t){return o.prototype.setCoordinates.call(this,t),this.gt&&this.et(),this.pt=!0,this},t.copy=function(){var t=this.toJSON();return i.fromJSON(t)},t.setShader=function(t){return o.prototype.updateSymbol.call(this,{shader:t}),this.Mt&&this.Mt.p(this),this.pt=!0,this},t.getShader=function(){var t=this._getInternalSymbol();return t&&t.shader||"phong"},t.setUniforms=function(t){return o.prototype.updateSymbol.call(this,{uniforms:t}),this.pt=!0,this},t.getUniforms=function(){var t=this._getInternalSymbol();return t&&t.uniforms},t.setUniform=function(t,i){var n=this.getUniforms()||{};return n[t]=i,o.prototype.updateSymbol.call(this,{uniforms:n}),this.pt=!0,this},t.getUniform=function(t){var i=this._getInternalSymbol();return i&&i.uniforms&&i.uniforms[t]},t.isAnimated=function(){var t=this._getInternalSymbol();return t&&t.animation&&this.yt&&this.yt.animations},t.setAnimation=function(t){return o.prototype.updateSymbol.call(this,{animation:t}),this.pt=!0,this},t.setAnimationloop=function(t){return o.prototype.updateSymbol.call(this,{loop:t}),this.pt=!0,this},t.isLooped=function(){var t=this._getInternalSymbol();return t&&t.loop},t.getAnimationSpeed=function(){var t=this._getInternalSymbol();return t&&t.speed||1},t.setAnimationSpeed=function(t){return o.prototype.updateSymbol.call(this,{speed:t}),this.pt=!0,this},t.nt=function(t){var i=this.getMap();return i?function(t,i,n){if(void 0===n&&(n=0),!(t&&i instanceof g.Coordinate))return null;var r=t.coordinateToPoint(i,t.getGLZoom());return[r.x,r.y,n]}(i,t||this.getCoordinates()):null},t.setTranslation=function(t){var i=t||this.gt.translation;return o.prototype.updateSymbol.call(this,{translation:i}),this.pt=!0,this.et(),this},t.getTranslation=function(){var t=this._getInternalSymbol();return t&&t.translation||this.gt.translation},t.At=function(){var t=this.getTranslation(),i=this.nt();return i?p.vec3.add(this.gt.translation,t,i):t},t.setRotation=function(t){return o.prototype.updateSymbol.call(this,{rotation:t}),this.pt=!0,this.et(),this},t.getRotation=function(){var t=this._getInternalSymbol();return t&&t.rotation||this.gt.rotation},t.setScale=function(t){var i=t=t||this.gt.scale;return o.prototype.updateSymbol.call(this,{scale:i}),this.pt=!0,this.et(),this},t.getScale=function(){var t=this._getInternalSymbol();return t&&t.scale||this.gt.scale},t.setFixSizeOnZoom=function(t){return o.prototype.updateSymbol.call(this,{fixSizeOnZoom:t}),this.pt=!0,this},t.getFixSizeOnZoom=function(){var t=this._getInternalSymbol();return t&&t.fixSizeOnZoom},t._setExternSymbol=function(t){return this.pt=!0,o.prototype._setExternSymbol.call(this,t)},t.Tt=function(t){var i=this;return function t(i,n){if(!i)return null;var r=!1;if(Array.isArray(i)){for(var e,o=[],s=0;s<i.length;s++)(e=t(i[s],n))?(o.push(e),r=!0):o.push(i[s]);return r?o:i}var u,h={__fn_types_loaded:!0},a=[];for(u in i)i.hasOwnProperty(u)&&a.push(u);for(var f=0,c=a.length;f<c;f++)F(i[u=a[f]])?(r=!0,h["_"+u]=i[u],function(i){Object.defineProperty(h,i,{get:function(){return this["__fn_"+i]||(this["__fn_"+i]=G(this["_"+i])),this["__fn_"+i].apply(this,n())},set:function(t){this["_"+i]=t},configurable:!0,enumerable:!0})}(u)):h[u]=i[u];return r?h:i}(t,function(){var t=i.getMap();return t?[t.getZoom()]:null})},t._prepareSymbol=function(t){o.prototype._prepareSymbol.call(this,t);var i=this.Tt(t);return i&&i.uniforms&&(i.uniforms=this.Tt(t.uniforms)),delete this.Ct,i},t.hasFunctionDefinition=function(){if(a(this.Ct))return this.Ct;var t=this._getInternalSymbol();return this.Ct=E(t)||t&&t.uniforms&&E(t.uniforms),this.Ct},t.onSymbolChanged=function(){o.prototype.onSymbolChanged.call(this),this.gt&&this.et(),this.Mt&&this.Mt.p(this)},t.setModelMatrix=function(t){var i=p.mat4.getTranslation(this.gt.translation,t),n=p.mat4.getRotation(this.gt.rotation,t),r=p.mat4.getScaling(this.gt.scale,t);return this.setTranslation(i),this.setRotation(n),this.setScale(r),this},t.getModelMatrix=function(){return this.mt},t.et=function(){var t=this.getRotation(),i=3===t.length?p.quat.fromEuler(J,t[0]||0,t[1]||0,t[2]||0):t;this.mt=p.mat4.fromRotationTranslationScale(this.mt,i,this.At(),this.getScale())},t.isDirty=function(){return this.pt},t.setDirty=function(t){return this.pt=t,this},t.on=function(t,i,n){o.prototype.on.call(this,t,i,n||this),this.Mt&&this.Mt.It(t)},t.off=function(t,i,n){o.prototype.off.call(this,t,i,n||this),this.Mt&&this.Mt.Nt()},t.toJSON=function(){var t=JSON.parse(JSON.stringify({coordinates:this.getCoordinates(),options:this.options})),i=this.getProperties();return t.options&&(t.options.properties=i),t},t.jt=function(t){this.lt=t},t.isLoaded=function(){return this.lt},t.getGLTFMarkerType=function(){return this.dt},t.Lt=function(t){this.Ft=t},t.g=function(){return this.Ft},t.getCount=function(){return 1},t.Y=function(t){this.Et=t},t.st=function(){return this.Et||[1,1,1]},t.W=function(t){this.Gt=t},t.U=function(){return this.Gt},t.getFitSizeScaleTest=function(){return this.Et},t.getFitTranslateTest=function(){return this.Gt},i}(g.Marker);R.mergeOptions({symbol:null}),R.registerJSONType("GLTFMarker");var V=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function z(t){if(!t)return"true";var i=t[0];return t.length<=1?"any"===i?"false":"true":"("+("=="===i?H(t[1],t[2],"===",!1):"!="===i?H(t[1],t[2],"!==",!1):"<"===i||">"===i||"<="===i||">="===i?H(t[1],t[2],i,!0):"any"===i?q(t.slice(1),"||"):"all"===i?q(t.slice(1),"&&"):"none"===i?U(q(t.slice(1),"||")):"in"===i?B(t[1],t.slice(2)):"!in"===i?U(B(t[1],t.slice(2))):"has"===i?X(t[1]):"!has"===i?U(X(t[1])):"true")+")"}function D(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function H(t,i,n,r){var e=D(t),o="$type"===t?V.indexOf(i):JSON.stringify(i);return(r?"typeof "+e+"=== typeof "+o+"&&":"")+e+n+o}function q(t,i){return t.map(z).join(i)}function B(t,i){"$type"===t&&(i=i.map(function(t){return V.indexOf(t)}));var n=JSON.stringify(i.sort($)),r=D(t);return i.length<=200?n+".indexOf("+r+") !== -1":"function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }("+r+", "+n+",0,"+(i.length-1)+")"}function X(t){return"$id"===t?'"id" in f':JSON.stringify(t)+" in p"}function U(t){return"!("+t+")"}function $(t,i){return t<i?-1:i<t?1:0}function Y(t){if(!Array.isArray(t))return Y([t]);for(var i,n=[],r=0;r<t.length;r++){var e=void 0,e=!0===t[r].filter?function(){return!0}:(i=t[r].filter,new Function("f","var p = (f && f.properties || {}); return "+z(i)));n.push(function(t){for(var i=1;i<arguments.length;i++){var n=arguments[i];for(var r in n)t[r]=n[r]}return t}({},t[r],{filter:e}))}return n}var W=/\{ *([\w_]+) *\}/g,Z=function(r){function i(t,i){var n=r.call(this,t,i)||this;return n.dt="effectmarker",n}u(i,r),i.fromJSON=function(t){return new i(t.coordinates,t.options)};var t=i.prototype;return t.isAnimated=function(){var t=this._getInternalSymbol();return t&&t.animation},t.setTexture=function(t){var i,n=this.getLayer()&&this.getLayer().getRenderer();return n&&(i=this.getTextureUrl(),n.Jt(i),n.Rt(t)),r.prototype.updateSymbol.call(this,{textureUrl:t}),this},t.Vt=function(t){var i=this.getTextureUrl(),n=this.getLayer()&&this.getLayer().getRenderer();if(n){var r,e,o,s=i,u=this.zt();return u&&(r=this.isLooped(),e=this.getAnimationSpeed()||1,o=r?Math.floor(.01*t*e)%u.length:Math.floor(.01*t),s=i.replace(W,u[o]),this.setUniform("width",1),this.setUniform("height",1),this.setUniform("uvOffset",[0,0])),n.Dt(s,this.g())}return null},t.zt=function(){var t=this._getInternalSymbol();return t&&t.textureNames},t.getTextureUrl=function(){var t=this._getInternalSymbol();return t&&t.textureUrl||"default"},t.getUrl=function(){return"plane"},t.getShader=function(){return"effect"},t.setTransparent=function(t){return this.options.symbol.transparent=t,this},t.isTransparent=function(){return this.options.symbol.transparent},t.updateUV=function(t){var i,n=this.isLooped(),r=this.getAnimationSpeed()||1,e=this.getUniforms()||{},o=e.width||1,s=e.height||1,u=this.getEffectType();"uv"===u?i=n?.01*t*r%(o*s):.01*t:"sequence"===u&&(i=n?Math.floor(.01*t*r)%(o*s):Math.floor(.01*t));var h=Number(i%o),a=Math.floor(i/o),f=this.Vt(t);this._getSymbol()?(this.setUniform("uvOffset",[h,a]),this.setUniform("width",o),this.setUniform("height",s),this.setUniform("texture",f)):this.wt("uniforms",{uvOffset:[h,a],width:o,height:s,texture:f})},t._setExternSymbol=function(t){r.prototype._setExternSymbol.call(this,t);var i,n=this.getLayer()&&this.getLayer().getRenderer();n&&(i=this.getTextureUrl(),n.Rt(i))},t.getEffectType=function(){var t=this._getInternalSymbol();return t&&t.effect||"uv"},t.setEffectType=function(t){return this._getInternalSymbol().effect=t,this},t.remove=function(){var t,i=this.getLayer()&&this.getLayer().getRenderer();i&&(t=this.getTextureUrl(),i.Jt(t)),r.prototype.remove.call(this)},i}(R),K=["Point","Polygon","LineString","MultiPoint","MultiPolygon","MultiLineString","GeometryCollection","Feature","FeatureCollection"].reduce(function(t,i){return t[i]=!0,t},{}),Q={toGeometry:function(t,i){if(g.Util.isString(t)&&(t=g.Util.parseJSON(t)),Array.isArray(t)){for(var n=[],r=0,e=t.length;r<e;r++){var o=Q.Ht(t[r],i);Array.isArray(o)?g.Util.pushIn(n,o):n.push(o)}return n}return Q.Ht(t,i)},Ht:function(t,i){if(!t||g.Util.isNil(t.type))return null;var n=t.type;if("Feature"===n){var r=t.geometry,e=Q.Ht(r,i);return e?(e.setId(t.id),e.setProperties(t.properties),e):null}if("FeatureCollection"===n){var o=t.features;return o?Q.toGeometry(o,i):null}if("Point"===n)return s=t.coordinates,new("EffectLayer"!==i?R:Z)(s);if("GeometryCollection"!==n)throw new Error("geometry's type is invalid, only support type of Point");for(var s,u=t.geometries,h=[],a=u.length,f=0;f<a;f++)h.push(Q.Ht(u[f],i));return h},isGeoJSON:function(t){return!(!t||"object"!=typeof t)&&(!!t.type&&(!!K[t.type]&&!(t instanceof g.Geometry)))}};var tt=[-1,0,-1,1,0,-1,-1,0,1,1,0,1],it=[0,1,0,0,1,0,0,1,0,0,1,0],nt=[3,1,0,0,2,3],rt=[0,0,1,0,0,1,1,1],et={cube:{scenes:[{nodes:[{mesh:0,meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1])},NORMAL:{array:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1])}},indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mode:4}]}]}]}]},plane:{scenes:[{nodes:[{mesh:0,meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(tt)},NORMAL:{array:new Int8Array(it)},TEXCOORD_0:{array:new Int8Array(rt)}},indices:new Uint16Array(nt),mode:4}]}]}]}]}};var ot,st=((ot=ut.prototype).qt=function(i){var t=i.getUrl();return p.reshader.GLTFHelper.load(t).then(function(t){return i.xt(t),t})},ot.loadModel=function(t){var i=t.getUrl();et[i]?this.Bt(t):this.Xt(t)},ot.Xt=function(t){var i=this;this.Mt.getRenderer()?this.Ut(t):this.Mt.on("renderercreate",function(){i.Ut(t)})},ot.Ut=function(i){var n=this,r=i.getUrl(),e=this.Mt.getRenderer();return this.requests[r]||(this.requests[r]=this.qt(i),this.requests[r].count=0),this.requests[r].then(function(t){n.Mt.$t[i.g()]&&n.requests[r]&&(i.xt(t),n.Yt[r]=t,e.q(i,r),e.p(i),n.requests[r].count+=1,n.requests[r].complete=!0,i.jt(!0),i.fire("load",{data:t}),n.Wt()&&n.Mt.fire("modelload",{models:n.getModels()}),i.fire("setUrl-debug"))})},ot.Wt=function(){for(var t=this.Mt._geoList,i=0;i<t.length;i++)if(!t[i].isLoaded())return!1;return!0},ot.Bt=function(i){var n=i.getUrl();this.Yt[n]=function(t){if(et[t])for(var i=et[t].scenes[0].nodes,n=0;n<i.length;n++)delete i[n].isParsed;return et[t]}(n),i.xt(this.Yt[n]);var t=this.Mt.getRenderer();t?t.q(i,n):this.Mt.on("renderercreate",function(t){t.renderer.q(i,n)}),i.jt(!0),i.fire("load",{data:i.B()})},ot.getModels=function(){return this.Yt},ot.removeRequests=function(t){this.requests[t]&&(--this.requests[t].count,this.requests[t].count<=0&&(delete this.requests[t],delete this.Yt[t]))},ot.clear=function(){this.requests={},this.Yt={}},ut);function ut(t){this.Mt=t,this.Yt={},this.requests={}}var ht=["mousedown","mouseup","mousemove","click","dbclick","touchstart","touchmove","touchend"],at=/\{*(\$root)*\}/g,ft=function(o){function t(t,i,n){var r;!i||i instanceof g.Geometry||Array.isArray(i)||K[i.type]||(n=i,i=null),(r=o.call(this,t,null,n)||this).pickingId=0,r.$t={},r.Zt={},r.mapEvents="",r.Kt=new st(s(s(r)));var e=n&&n.style;return r.setStyle(e),i&&r.addGeometry(i),r}u(t,o),t.registerShader=function(t,i,n,r){y[t]={name:t,type:i,config:n,uniforms:r}},t.removeShader=function(t){delete y[t]},t.getShaders=function(){var t=[];for(var i in y)t.push({shader:i,uniforms:y[i].uniforms});return t},t.getShaderMap=function(){return y};var i=t.prototype;return i.addGeometry=function(t,i){for(var n=Q.isGeoJSON(t)?Q.toGeometry(t,this.getJSONType()):t,n=Array.isArray(n)?n:[n],r=0;r<n.length;r++)if(!this.Qt(n[r]))return void console.error("type of geometry is invalid");o.prototype.addGeometry.call(this,n,i),Array.isArray(n)&&this.addMarker(n)},i.addMarker=function(t){for(var i=0;i<t.length;i++){var n=t[i];n.Lt(this.pickingId),((this.$t[this.pickingId]=n).Mt=this).It(n.getListeningEvents());var r=n.getId();r&&(this.Zt[r]=n),n.fire("add",{type:"add",target:n,layer:this}),"groupgltfmarker"===n.getGLTFMarkerType()?this.pickingId+=n.getCount():this.pickingId++,this.Ot(n)}},i.Ot=function(t){this.Kt.loadModel(t)},i.getModels=function(){return this.Kt.getModels()},i.toJSON=function(t){t=t||{};var i={type:this.getJSONType(),id:this.getId(),options:this.config()};if((h(t.style)||t.style)&&(i.style=this.getStyle()),h(t.geometries)||t.geometries){for(var n=[],r=this._geoList,e=0;e<r.length;e++){var o=r[e].toJSON();n.push(o)}i.geometries=n}return i},i.Qt=function(t){return!!t.getGLTFMarkerType&&-1<this.options.marekrTypes.indexOf(t.getGLTFMarkerType())},i.setStyle=function(t){return t?(this.options.style=t,this.ti=JSON.parse(JSON.stringify(t)),this.ii()):(delete this.ti,delete this.options.style),this},i.getStyle=function(){return this.options.style},i.updateSymbol=function(t,i){var n=this.getStyle();this.ni(t,i,n),this.ni(t,i,this.ti),this.ii()},i.ni=function(t,i,n){if(n){var r=(n.style?n.style:n)[t].symbol||{};for(var e in i)r[e]=i[e]}},i.ii=function(){this.ri(this.ti);var t=this.ti.style?this.ti.style:this.ti;this.ei=Y(t),this._geoList.forEach(function(t){this.oi(t)},this)},i.getGLTFUrls=function(){return Object.keys(this.Kt.requests)},i.It=function(t){var i=this,n=g.Util.isString(t)?t.split(/\s+/).map(function(t){return"mouseleave"===t||"mouseenter"===t||"mouseout"===t?"mousemove":t}):t,r=this.mapEvents,e=f(n,ht).filter(function(t){return i.mapEvents.indexOf(t)<0});this.mapEvents+=" "+e.join(" "),this.mapEvents=this.mapEvents.trim();var o=this.getMap();o&&(o.off(r,this.si,this),o.on(this.mapEvents,this.si,this))},i.Nt=function(){for(var t={},i=this.mapEvents,n=this._geoList,r=0;r<n.length;r++)for(var e=n[r].getListeningEvents().map(function(t){return"mouseleave"===t||"mouseenter"===t||"mouseout"===t?"mousemove":t}),o=0;o<e.length;o++)t[e[o]]=1;this.mapEvents=f(Object.keys(t),ht).join(" ");var s=this.getMap();s&&(s.off(i,this.si,this),s.on(this.mapEvents,this.si,this))},i.ri=function(n){g.Util.isString(n.$root)&&n.style.forEach(function(t){var i=t.symbol.url;i&&-1<i.indexOf("{$root}")&&(t.symbol.url=i.replace(at,n.$root))})},i.oi=function(t){if(!this.ei)return!1;for(var i=0,n=this.ei.length;i<n;i++)if(!0===this.ei[i].filter({properties:t.getProperties()})){var r=this.ei[i].symbol,e=r.url;return t.wt("url",e),this.Kt.loadModel(t),t._setExternSymbol(r),!0}return!1},i.removeGeometry=function(t){var i=this;o.prototype.removeGeometry.call(this,t),Array.isArray(t)?t.forEach(function(t){i.Pt(t),i.Nt()}):(this.Pt(t),this.Nt())},i.getMapEvents=function(){return this.mapEvents},i.Pt=function(t){var i=t.getUrl(),n=g.Util.isString(t)?this.Zt[t].g():t.g();this.Kt.removeRequests(i);var r=this.getRenderer();r&&r.ht(n),delete this.$t[n],delete this.Zt[t]},i.clear=function(){var t=this.getRenderer();return t&&t.ft(),this.$t={},o.prototype.clear.call(this),this.Kt.clear(),this.Zt={},this},i.getRequestsTest=function(){return this.Kt.requests},i.o=function(){return this.$t},i.ct=function(t,i,n){var r=this.getRenderer();return r?r.ct(t,i,n):null},i.it=function(){return this.options.fitSize},i.si=function(t){if(this.options.markerEvents){var i=this.getMap();if(i){this.ui=this.hi,this.ai=this.fi,this.ci=this.vi,this.li=this.mi;var n=i.coordinateToContainerPoint(t.coordinate,i.getGLZoom()),r=Math.round(n.x),e=Math.round(n.y);if(r<=0||r>=i.width||e<=0||e>=i.height)return this.hi=null,this.vi=null,void(this.fi=null);var o=this.ct(r,e);o&&(this.hi=o.target?o.target.g():null,this.vi=o.meshId,this.fi=JSON.stringify(o.point),this.mi=o.pickingId,"mousemove"===t.type?this.di().forEach(function(t){t.target.fire(t.type,t),"mousemove"===t.type||"mouseenter"===t.type?t.target.St(!0):t.target.St(!1)}):o.target&&o.target.fire(t.type,{type:t.type,target:o.target,meshId:o.meshId,pickingId:o.pickingId,point:o.point}))}}},i.di=function(){var t=[];return a(this.hi)&&!a(this.ui)?t.push({type:"mouseenter",target:this.$t[this.hi],meshId:this.vi,pickingId:this.mi,point:JSON.parse(this.fi)}):!a(this.hi)&&a(this.ui)?t.push({type:"mouseout",target:this.$t[this.ui],meshId:this.ci,pickingId:this.li,point:JSON.parse(this.ai)},{type:"mouseleave",target:this.$t[this.ui],meshId:this.ci,pickingId:this.li,point:JSON.parse(this.ai)}):a(this.hi)&&a(this.ui)&&(this.hi===this.ui?t.push({type:"mousemove",target:this.$t[this.hi],meshId:this.vi,pickingId:this.mi,point:JSON.parse(this.fi)}):t.push({type:"mouseenter",target:this.$t[this.hi],meshId:this.vi,pickingId:this.mi,point:JSON.parse(this.fi)},{type:"mouseout",target:this.$t[this.ui],meshId:this.ci,pickingId:this.li,point:JSON.parse(this.ai)},{type:"mouseleave",target:this.$t[this.ui],meshId:this.ci,pickingId:this.li,point:JSON.parse(this.ai)})),t},i.p=function(t){var i=this.getRenderer();i&&i.p(t)},t}(g.OverlayLayer);ft.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,markerEvents:!0,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,fitSize:100});var ct=function(i){function s(){return i.apply(this,arguments)||this}u(s,i),s.initDefaultShader=function(){var t={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL"},material:new p.reshader.PhongMaterial};s.registerShader("phong","PhongShader",t.shader,t.material.getUniforms());var i={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{cull:{enable:!1,face:"back"},frontFace:"cw"}},material:new p.reshader.WireFrameMaterial};s.registerShader("wireframe","WireframeShader",i.shader,i.material.getUniforms());var n={shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",tangentAttribute:"TANGENT",colorAttribute:"COLOR_0",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",extraCommandProps:{cull:{enable:!0},frontFace:"ccw"},defines:{HAS_IBL_LIGHTING:1}},material:new p.reshader.pbr.StandardMaterial({})};s.registerShader("pbr","pbr.StandardShader",n.shader,n.material.getUniforms())},s.fromJSON=function(t){if(!t||"GLTFLayer"!==t.type)return null;for(var i=new s(t.id,t.options),n=t.geometries,r=[],e=0;e<n.length;e++){var o=R.fromJSON(n[e]);o&&r.push(o)}return i.addGeometry(r),t.style&&i.setStyle(t.style),i};var t=s.prototype;return t.onAdd=function(){this.getMap().on(this.mapEvents,this.si,this),i.prototype.onAdd.call(this)},t.remove=function(){var t=this.getMap();t&&(t.off(this.mapEvents,this.si),i.prototype.remove.call(this))},t.identify=function(t,i){var n=this.getMap(),r=n.coordinateToContainerPoint(t,n.getGLZoom()),e=Math.round(r.x),o=Math.round(r.y);return this.ct(e,o,i)},t.pi=function(){var i=this,t=this.getRenderer();t?this.gi(t.gltfScenes):this.on("renderercreate",function(t){i.gi(t.renderer.gltfScenes)})},t.gi=function(t){for(var i in this.pickingId=0,this.$t){var n=this.$t[i],r=t[i],e=n.g();delete this.$t[e],delete t[e],n.Lt(this.pickingId),this.$t[this.pickingId]=n,t[this.pickingId]=r;var o=n.getCount();this.pickingId+=o}},s}(ft);ct.initDefaultShader(),ct.mergeOptions({marekrTypes:["gltfmarker","groupgltfmarker"]}),ct.registerJSONType("GLTFLayer"),ct.registerRenderer("gl",k);var vt=[1,1,1,1],lt=[],mt=[],dt=function(r){function i(t,i){var n=r.call(this,null,i)||this;return n.yi=t,n.xi=[],n.dt="groupgltfmarker",n}u(i,r),i.fromJSON=function(t){return new i(t.data,t.options)};var t=i.prototype;return t.setCoordinates=function(t){return Array.isArray(t[0])?this.wi=t.map(function(t){return new g.Coordinate(t)}):this.wi=t,this.updateAllData("coordinates",this.wi),this.pt=!0,this},t.addData=function(t){this.yi.push(t);var i=this.getLayer();return i&&i.pi(),this.pt=!0,this},t.removeData=function(t){return this.yi.splice(t,1),this.V&&this.xi.splice(t,1),this.pt=!0,this},t.getData=function(t){return this.yi[t]},t.updateData=function(t,i,n){return this.yi[t][i]=n,this.pt=!0,this},t.updateAllData=function(t,i){for(var n=0;n<this.yi.length;n++)this.updateData(n,t,i[n]);return this},t.V=function(){if(this.yi){this.xi=this.xi||[];for(var t=0;t<this.yi.length;t++){var i=this.bi(t);this.xi[t]=i}}},t.bi=function(t){var i=this.yi[t],n=this.nt(i.coordinates),r=p.vec3.add(lt,i.translation||this.gt.translation,n||this.gt.translation),e=i.rotation||this.gt.rotation,o=i.scale||this.gt.scale,s=p.quat.fromEuler(mt,e[0]||0,e[1]||0,e[2]||0);return p.mat4.fromRotationTranslationScale(this.xi[t]||[],s,r,o)},t.et=function(){r.prototype.et.call(this),this.V()},t.Mi=function(){this.Oi&&this.Oi.instance_vectorA.length/4===this.xi.length||(this.Oi={instance_vectorA:[],instance_vectorB:[],instance_vectorC:[],instance_vectorD:[],instance_color:[],aPickingId:[]});for(var t=0;t<this.xi.length;t++){var i=this.xi[t];this._i("instance_vectorA",t,0,4,i),this._i("instance_vectorB",t,1,4,i),this._i("instance_vectorC",t,2,4,i),this._i("instance_vectorD",t,3,4,i),this._i("instance_color",t,0,1,this.yi[t].color||vt),this.Oi.aPickingId[t]=this.g()+t}return this.Oi},t._i=function(t,i,n,r,e){this.Oi[t][4*i]=e[n*r],this.Oi[t][4*i+1]=e[n*r+1],this.Oi[t][4*i+2]=e[n*r+2],this.Oi[t][4*i+3]=e[n*r+3]},t.z=function(t){return this.pt?this.Mi(t):this.Oi},t.getCount=function(){return this.yi.length},t.toJSON=function(){var t=JSON.parse(JSON.stringify({data:this.yi,options:this.options})),i=this.getProperties();return t.options&&(t.options.properties=i),t},t.getIndexByPickingId=function(t){return t-this.g()},i}(R),pt=new p.reshader.Texture2D({url:void 0,mag:"linear"}),gt=function(n){function t(t){var i=n.call(this,t)||this;return i._textureMap={},i}u(t,n);var i=t.prototype;return i.Dt=function(t){return this.regl&&this._textureMap[t]?this._textureMap[t].texture.getREGLTexture(this.regl):pt},i.Rt=function(t){var i,n,r=this;this._textureMap[t]?this._textureMap[t].count++:(this.Pi=this.Pi||new p.reshader.ResourceLoader,i="default"===t?void 0:t,(n=new p.reshader.Texture2D({url:i,mag:"linear"},this.Pi)).once("complete",function(){r.setToRedraw()},this),this._textureMap[t]={count:1,texture:n})},i.Jt=function(t){this._textureMap[t]&&(this._textureMap[t].count--,this._textureMap[t].count<1&&(this._textureMap[t].texture.dispose(),delete this._textureMap[t]))},t}(k),yt=function(r){function e(){return r.apply(this,arguments)||this}u(e,r),e.initDefaultShader=function(){var t,i,n=(t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a;\n        }\n    ",uniforms:["texture","uvOffset","width","height","projViewMatrix"],positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},i=new p.reshader.Material,{shader:t,material:i});e.registerShader("effect","MeshShader",n.shader,n.material.getUniforms())};var t=e.prototype;return t.onAddGeometry=function(t){r.prototype.onAddGeometry.call(this,t);var i=t.getTextureUrl(),n=this.getRenderer();n?n.Rt(i):this.on("renderercreate",function(t){t.renderer.Rt(i)})},t.remove=function(){var n=this.getRenderer();n&&this._geoList.forEach(function(t){var i=t.getTextureUrl();n.Jt(i)}),r.prototype.remove.call(this)},t.clear=function(){var n=this.getRenderer();n&&this._geoList.forEach(function(t){var i=t.getTextureUrl();n.Jt(i)}),r.prototype.clear.call(this)},t.getTextureMapTest=function(){var t=this.getRenderer();return t?t._textureMap:null},e}(ft);yt.initDefaultShader(),yt.mergeOptions({marekrTypes:["effectmarker"]}),yt.registerJSONType("EffectLayer"),yt.registerRenderer("gl",gt);var xt=function(r){function i(t,i){var n=r.call(this,t,i)||this;return n.dt="glowmarker",n}u(i,r),i.fromJSON=function(t){return new i(t.coordinates,t.options)};var t=i.prototype;return t.getUrl=function(){return"plane"},t.setSpeed=function(t){this.setUniform("speed",t)},t.getSpeed=function(){return this._getInternalSymbol().uniforms.speed},t.getShader=function(){return"glowmarker"},t.isAnimated=function(){var t=this._getInternalSymbol();return t&&t.animation},t.H=function(){var t=this._getInternalSymbol();t.uniforms.time=t.uniforms.time||0,t.uniforms.time+=.01},i}(R);xt.mergeOptions({visible:!0});var wt,bt=(u(Mt,wt=ft),Mt.initDefaultShader=function(){var t,i,n=(t={vert:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        attribute vec3 aPosition;\n        uniform mat4 projViewModelMatrix;\n        uniform mat4 modelMatrix;\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        void main(){\n            gl_Position=projViewModelMatrix*vec4(aPosition,1.);\n            vec4 worldPos = modelMatrix * vec4(aPosition, 1.0);\n            v_FragPos = worldPos.xyz;\n            v_center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;\n        }\n    ",frag:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        #define pi 3.14159\n        const float dotsnb = 30.0; // Number of dots\n\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        uniform float time;\n        uniform float radius;\n        uniform vec3 color;\n        uniform float speed;\n        vec3 hsb2rgb(in vec3 c)\n        {\n            vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0,0.0,1.0 );\n            rgb = rgb*rgb*(4.0-2.0*rgb);\n            return c.z * mix( vec3(1.0), rgb, c.y);\n        }\n\n        void main()\n        {\n            float r = length(v_FragPos - v_center);\n            r = r*2.-1.;\n            if(r>radius) {\n                gl_FragColor = vec4(1.0,1.0,1.0, 0.0);\n            } else {\n                //vec3 color = hsb2rgb(vec3(fract(time*.1),.7,.4));\n                vec3 color = color;\n                float s = abs(sin(pow(r+5.0, 1.5)-time*speed+sin(r*0.9))*sin(r+.99));\n                color *= (abs(1./(s*10.8))-.01);\n                gl_FragColor = vec4(color, (color.x + color.y + color.z) / 1.0);\n            }\n        }\n    ",uniforms:["time","radius","color","speed",{name:"projViewModelMatrix",type:"function",fn:function(t,i){return p.mat4.multiply([],i.projViewMatrix,i.modelMatrix)}}],positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,0]}}},i=new p.reshader.Material,{shader:t,material:i});Mt.registerShader("glowmarker","MeshShader",n.shader,n.material.getUniforms())},Mt);function Mt(){return wt.apply(this,arguments)||this}bt.initDefaultShader(),bt.mergeOptions({marekrTypes:["glowmarker"]}),bt.registerJSONType("GlowMarkerLayer"),bt.registerRenderer("gl",k);var Ot,_t={url:"plane",animation:!0,loop:!0,rotation:[0,0,0],translation:[0,0,30],scale:[1,1,30]},Pt={width:1,height:1,modelHeight:60,startOpacity:0,endOpacity:1},St=function(o){function t(t,i){var n=o.call(this,t,i)||this,r=g.Util.extend({},_t,n.options.symbol);n.setSymbol(r);var e=g.Util.extend({},Pt,n.options.symbol.uniforms);return n.setUniforms(e),n.setShader("effectline"),n.dt="effectmarker",n}u(t,o);var i=t.prototype;return i.getEffectType=function(){return"sequence"},i.setTexture=function(t){return this.setUniform("texture",t),this},i.setHeight=function(t){return this.setUniform("modelHeight",t),this},i.setStartOpacity=function(t){return this.setUniform("startOpacity",t),this},i.setEndOpacity=function(t){return this.setUniform("endOpacity",t),this},t}(Z),kt=(u(At,Ot=ft),At.initDefaultShader=function(){var t,i,n=(t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        varying float vHeight;\n        void main()\n        {\n            vec4 worldPosition = modelMatrix * vec4(aPosition, 1.0);\n            gl_Position = projViewMatrix * worldPosition;\n            vHeight = worldPosition.z;\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n        uniform float modelHeight;\n        uniform float startOpacity;\n        uniform float endOpacity;\n        varying float vHeight;\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            float opacity = (endOpacity - startOpacity) * (1.0 - vHeight / modelHeight);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a * opacity;\n        }\n    ",uniforms:["texture","uvOffset","width","height","modelHeight","startOpacity","endOpacity","projViewMatrix"],positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},i=new p.reshader.Material,{shader:t,material:i});At.registerShader("effectline","MeshShader",n.shader)},At);function At(){return Ot.apply(this,arguments)||this}kt.initDefaultShader(),kt.mergeOptions({marekrTypes:["effectmarker"]}),kt.registerJSONType("EffectLineLayer"),kt.registerRenderer("gl",k);var Tt,Ct={offsetX:0,offsetY:0,uReflectivity:.8,opacity:.9,color:[.9,0,0,1]},It=(u(Nt,Tt=R),Nt);function Nt(t,i){var n=Tt.call(this,t,i)||this,r=g.Util.extend({},Ct,n.options.symbol.uniforms);return n.setUniforms(r),n.setShader("effectring"),n.dt="effectring",n}var jt,Lt=(u(Ft,jt=ft),Ft.initDefaultShader=function(){var t,i,n=(t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        attribute vec3 aNormal;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 normalMatrix;\n        uniform float offsetX;\n        uniform float offsetY;\n        varying vec2 uv;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            uv = vec2(aTexCoord.x + offsetX, aTexCoord.y + offsetY);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D effectTexture;\n        uniform vec3 uCameraPosition;\n        uniform mat4 viewMatrix;\n        uniform float uReflectivity;\n        uniform vec4 color;\n        uniform float opacity;\n\n        varying vec2 uv;\n\n        vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n            return normalize((vec4(dir, 0.0) * matrix).xyz);\n        }\n\n        const float GAMMA_FACTOR = 2.0;\n        vec4 GammaToLinear(in vec4 value, in float gammaFactor) {\n            return vec4(pow(value.xyz, vec3(gammaFactor)), value.w);\n        }\n\n        vec4 mixTexelToLinear(vec4 value) {\n            return GammaToLinear(value, float(GAMMA_FACTOR));\n        }\n\n        void main() {\n            vec4 texColor = texture2D(effectTexture, uv);\n            if (color.a == 0.0) {\n                discard;\n            }\n            vec4 mixColor = mixTexelToLinear(color);\n            texColor.rgb += mixColor.xyz * uReflectivity;\n            texColor.a*= opacity;\n            gl_FragColor = texColor;\n        }\n    ",uniforms:["projViewMatrix","viewMatrix","offsetX","offsetY","effectTexture","uCameraPosition","uReflectivity","color","opacity",{name:"normalMatrix",type:"function",fn:function(t,i){var n=[];return p.mat4.invert(n,i.modelMatrix),p.mat4.transpose(n,n),n}}],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},i=new p.reshader.Material,{shader:t,material:i});Ft.registerShader("effectring","MeshShader",n.shader)},Ft);function Ft(){return jt.apply(this,arguments)||this}Lt.initDefaultShader(),Lt.mergeOptions({marekrTypes:["effectring"]}),Lt.registerJSONType("EffectRingLayer"),Lt.registerRenderer("gl",k);var Et,Gt={animation:!0,loop:!0,url:"plane",effect:"sequence",speed:1,scale:[1,1,1],rotation:[90,0,0]},Jt={width:9,height:5},Rt=(u(Vt,Et=Z),Vt);function Vt(t,i){var n=Et.call(this,t,i)||this,r=g.Util.extend({},Gt,n.options.symbol);n.setSymbol(r);var e=g.Util.extend({},Jt,n.options.symbol.uniforms);return n.setUniforms(e),n}t.AEMarker=Rt,t.EffectLayer=yt,t.EffectLine=St,t.EffectLineLayer=kt,t.EffectMarker=Z,t.EffectRing=It,t.EffectRingLayer=Lt,t.GLTFLayer=ct,t.GLTFMarker=R,t.GlowMarker=xt,t.GlowMarkerLayer=bt,t.GroupGLTFMarker=dt,Object.defineProperty(t,"Si",{value:!0}),"undefined"!=typeof console&&console.log("@maptalks/gltf-layer v0.12.3, requires maptalks@<2.0.0.")});
